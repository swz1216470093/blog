<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">


<link rel="stylesheet" href="/blog/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"swz1216470093.github.io","root":"/blog/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="类加载与字节码1.类文件结构将HelloWorld.java编译 12345public class HelloWorld &amp;#123;    public static void main(String[] args) &amp;#123;        System.out.println(&quot;hello world&quot;);    &amp;#125;&amp;#125;  执行 javac -par">
<meta property="og:type" content="article">
<meta property="og:title" content="类加载与字节码">
<meta property="og:url" content="https://swz1216470093.github.io/blog/2021/07/29/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81/index.html">
<meta property="og:site_name" content="swz&#39;blog">
<meta property="og:description" content="类加载与字节码1.类文件结构将HelloWorld.java编译 12345public class HelloWorld &amp;#123;    public static void main(String[] args) &amp;#123;        System.out.println(&quot;hello world&quot;);    &amp;#125;&amp;#125;  执行 javac -par">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718132420364.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718132546669.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718133746939.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140103397.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140126212.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140130985.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140153638.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140207715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140212852.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140229738.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140235416.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144038345.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144203337.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144805204.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144813264.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144855717.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144925709.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144944047.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145000294.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145050984.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145920462.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220509988.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220732187.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220937979.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719221549539.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719221815476.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719215926573.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718211545368.png">
<meta property="og:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210720000140849.png">
<meta property="article:published_time" content="2021-07-29T05:29:32.000Z">
<meta property="article:modified_time" content="2021-07-29T07:41:08.620Z">
<meta property="article:author" content="swz">
<meta property="article:tag" content="类加载器">
<meta property="article:tag" content="字节码">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718132420364.png">

<link rel="canonical" href="https://swz1216470093.github.io/blog/2021/07/29/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>类加载与字节码 | swz'blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">swz'blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://swz1216470093.github.io/blog/2021/07/29/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="swz">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="swz'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          类加载与字节码
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-07-29 13:29:32 / Modified: 15:41:08" itemprop="dateCreated datePublished" datetime="2021-07-29T13:29:32+08:00">2021-07-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/JVM/" itemprop="url" rel="index"><span itemprop="name">JVM</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="类加载与字节码"><a href="#类加载与字节码" class="headerlink" title="类加载与字节码"></a>类加载与字节码</h1><h2 id="1-类文件结构"><a href="#1-类文件结构" class="headerlink" title="1.类文件结构"></a>1.类文件结构</h2><p>将HelloWorld.java编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 javac -parameters -d . HellowWorld.java</p>
<span id="more"></span>

<p>编译为 HelloWorld.class 后是这个样子的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ od -t xC HelloWorld.class</span><br><span class="line">0000000 ca fe ba be 00 00 00 34 00 1f 0a 00 06 00 11 09</span><br><span class="line">0000020 00 12 00 13 08 00 14 0a 00 15 00 16 07 00 17 07</span><br><span class="line">0000040 00 18 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29</span><br><span class="line">0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e</span><br><span class="line">0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 04 6d 61 69</span><br><span class="line">0000120 6e 01 00 16 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67</span><br><span class="line">0000140 2f 53 74 72 69 6e 67 3b 29 56 01 00 10 4d 65 74</span><br><span class="line">0000160 68 6f 64 50 61 72 61 6d 65 74 65 72 73 01 00 04</span><br><span class="line">0000200 61 72 67 73 01 00 0a 53 6f 75 72 63 65 46 69 6c</span><br><span class="line">0000220 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64 2e 6a</span><br><span class="line">0000240 61 76 61 0c 00 07 00 08 07 00 19 0c 00 1a 00 1b</span><br><span class="line">0000260 01 00 0b 48 65 6c 6c 6f 20 77 6f 72 6c 64 07 00</span><br><span class="line">0000300 1c 0c 00 1d 00 1e 01 00 0a 48 65 6c 6c 6f 57 6f</span><br><span class="line">0000320 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61 6e 67 2f</span><br><span class="line">0000340 4f 62 6a 65 63 74 01 00 10 6a 61 76 61 2f 6c 61</span><br><span class="line">0000360 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f 75 74 01</span><br><span class="line">0000400 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 69 6e 74</span><br><span class="line">0000420 53 74 72 65 61 6d 3b 01 00 13 6a 61 76 61 2f 69</span><br><span class="line">0000440 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 01 00 07</span><br><span class="line">0000460 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a 61 76 61</span><br><span class="line">0000500 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 29 56 00</span><br><span class="line">0000520 21 00 05 00 06 00 00 00 00 00 02 00 01 00 07 00</span><br><span class="line">0000540 08 00 01 00 09 00 00 00 1d 00 01 00 01 00 00 00</span><br><span class="line">0000560 05 2a b7 00 01 b1 00 00 00 01 00 0a 00 00 00 06</span><br><span class="line">0000600 00 01 00 00 00 06 00 09 00 0b 00 0c 00 02 00 09</span><br><span class="line">0000620 00 00 00 25 00 02 00 01 00 00 00 09 b2 00 02 12</span><br><span class="line">0000640 03 b6 00 04 b1 00 00 00 01 00 0a 00 00 00 0a 00</span><br><span class="line">0000660 02 00 00 00 08 00 08 00 09 00 0d 00 00 00 05 01</span><br><span class="line">0000700 00 0e 00 00 00 01 00 0f 00 00 00 02 00 10</span><br><span class="line">0000716</span><br></pre></td></tr></table></figure>

<p>根据JVM规范，类文件结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile&#123;</span><br><span class="line">    u4 magic;</span><br><span class="line">    u2 minor_version;</span><br><span class="line">    u2 major_version;</span><br><span class="line">    u2 constant_pool_count;</span><br><span class="line">    cp_info constant_pool[constant_pool_count-<span class="number">1</span>];</span><br><span class="line">    u2 access_flags;</span><br><span class="line">    u2 this_class;</span><br><span class="line">    u2 super_class;</span><br><span class="line">    u2 interfaces_count;</span><br><span class="line">    u2 interfaces[interfaces_count];</span><br><span class="line">    u2 fields_count;</span><br><span class="line">    field_info fields[fields_count];</span><br><span class="line">    u2 methods_count;</span><br><span class="line">    method_info methods[methods_count];</span><br><span class="line">    u2 attributes_count;</span><br><span class="line">    attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1魔数"><a href="#1-1魔数" class="headerlink" title="1.1魔数"></a>1.1魔数</h3><p>0-3字节，表示它是否是class文件</p>
<p>0000000 <strong>ca fe ba be</strong> 00 00 00 34 00 1f 0a 00 06 00 11 09</p>
<h3 id="1-2-版本"><a href="#1-2-版本" class="headerlink" title="1.2 版本"></a>1.2 版本</h3><p>4~7 字节，表示类的版本 00 34（52） 表示是 Java 8<br>0000000 ca fe ba be <strong>00 00 00 34</strong> 00 1f 0a 00 06 00 11 09</p>
<h3 id="1-3-常量池"><a href="#1-3-常量池" class="headerlink" title="1.3 常量池"></a>1.3 常量池</h3><table>
<thead>
<tr>
<th>类型</th>
<th>标志</th>
<th>项目</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>CONSTANT_Utf8_info</td>
<td>1</td>
<td>tag : u1 <br>length: u2<br>bytes: u1</td>
<td>UTF-8编码的字符串</td>
</tr>
<tr>
<td>CONSTANT_Integer_info</td>
<td>3</td>
<td>tag:u1 <br>bytes:u4</td>
<td>整形字面量</td>
</tr>
<tr>
<td>CONSTANT_Float_info</td>
<td>4</td>
<td>tag:u1 <br>bytes:u4</td>
<td>浮点型字面量</td>
</tr>
<tr>
<td>CONSTANT_Long_info</td>
<td>5</td>
<td>tag:u1 <br/>bytes:u8</td>
<td>长整形字面量</td>
</tr>
<tr>
<td>CONSTANT_Double_info</td>
<td>6</td>
<td>tag:u1 <br/>bytes:u8</td>
<td>双精度浮点型字面量</td>
</tr>
<tr>
<td>CONSTANT_Class_info</td>
<td>7</td>
<td>tag:u1 <br>index:u2</td>
<td>类或接口的符号引用</td>
</tr>
<tr>
<td>CONSTANT_String_info</td>
<td>8</td>
<td>tag:u1 <br/>index:u2</td>
<td>字符串类型字面量</td>
</tr>
<tr>
<td>CONSTANT_Fieldref_info</td>
<td>9</td>
<td>tag:u1 <br/>index:u2<br>index:u2</td>
<td>字段的符号引用</td>
</tr>
<tr>
<td>CONSTANT_Methodref_info</td>
<td>10 / 0a</td>
<td>tag:u1 <br/>index:u2<br/>index:u2</td>
<td>类中方法的符号引用</td>
</tr>
<tr>
<td>CONSTANT_InterfaceMethodref_info</td>
<td>11 / 0b</td>
<td>tag:u1 <br/>index:u2<br/>index:u2</td>
<td>接口中方法的符号引用</td>
</tr>
<tr>
<td>CONSTANT_NameAndType_info</td>
<td>12 / 0c</td>
<td>tag:u1 <br/>index:u2<br/>index:u2</td>
<td>字段或方法的部分符号引用</td>
</tr>
<tr>
<td>CONSTANT_MethodHandle_info</td>
<td>15 / 0f</td>
<td>tag:u1<br>reference_kind:u1 <br>referfence_index:u2</td>
<td>表示方法句柄</td>
</tr>
<tr>
<td>CONSTANT_MethodType_info</td>
<td>16 / 10</td>
<td>tag:u1<br>descriptor_index:u2</td>
<td>表示方法类型</td>
</tr>
<tr>
<td>CONSTANT_InvokeDynamic_info</td>
<td>18 / 12</td>
<td>tag:u1<br>bootstrap_method_attr_index:u2<br>name_and_type_index:u2</td>
<td>表示一个动态方法调用点</td>
</tr>
</tbody></table>
<p>8-9 字节，表示常量池长度，00 1f （31） 表示常量池有 #1-#30项，注意 #0 项不计入，也没有值</p>
<p>0000000 ca fe ba be 00 00 00 34 <strong>00 1f</strong> 0a 00 06 00 11 09</p>
<p>第#1项 0a 表示一个 Method 信息，00 06 和 00 11（17） 表示它引用了常量池中 #6 和 #17 项来获得<br>这个方法的【所属类】和【方法名】</p>
<p>0000000 ca fe ba be 00 00 00 34 00 1f <strong>0a 00 06 00 11</strong> 09</p>
<p>第#2项 09 表示一个 Field 信息，00 12（18）和 00 13（19） 表示它引用了常量池中 #18 和 # 19 项<br>来获得这个成员变量的【所属类】和【成员变量名】<br>0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 <strong>09</strong><br>0000020 <strong>00 12 00 13</strong> 08 00 14 0a 00 15 00 16 07 00 17 07<br>第#3项 08 表示一个字符串常量名称，00 14（20）表示它引用了常量池中 #20 项</p>
<p>0000020 00 12 00 13 <strong>08</strong> <strong>00 14</strong> 0a 00 15 00 16 07 00 17 07</p>
<h3 id="1-4-继承和访问标识信息"><a href="#1-4-继承和访问标识信息" class="headerlink" title="1.4 继承和访问标识信息"></a>1.4 继承和访问标识信息</h3><p>21 表示该 class 是一个类，公共的<br>0000500 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 29 56 <strong>00</strong></p>
<p>0000520 <strong>21</strong> 00 05 00 06 00 00 00 00 00 02 00 01 00 07 00</p>
<p>05 表示根据常量池中 #5 找到本类全限定名<br>0000520 21 <strong>00 05</strong> 00 06 00 00 00 00 00 02 00 01 00 07 00<br>06 表示根据常量池中 #6 找到父类全限定名<br>0000520 21 00 05 <strong>00 06</strong> 00 00 00 00 00 02 00 01 00 07 00<br>表示接口的数量，本类为 0<br>0000520 21 00 05 00 06 <strong>00 00</strong> 00 00 00 02 00 01 00 07 00</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>是否为public类型</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>是否被声明为final，只有类可设置</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>是否允许使用invokespecial字节码指令的新语言，invokespecial指令的语意在JDK1.0.2发生过改变，为了区别这条指令使用哪种语意，JDK1.0.2之后编译出来的类的这个标志都必须为真</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>标识这是一个接口</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>是否为abstract类型，对于接口或者抽象类来说，此标志值为真，其他类值为假</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>标识这个类并非由用户代码产生的</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>标识这是一个注解</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>标识这是一个枚举</td>
</tr>
</tbody></table>
<h3 id="1-5-Field-信息"><a href="#1-5-Field-信息" class="headerlink" title="1.5 Field 信息"></a>1.5 Field 信息</h3><p>表示成员变量数量，本类为 0<br>0000520 21 00 05 00 06 00 00 <strong>00 00</strong> 00 02 00 01 00 07 00</p>
<table>
<thead>
<tr>
<th>FieldType</th>
<th>Type</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>byte</td>
<td>[基本类型] 有符号的字节</td>
</tr>
<tr>
<td>C</td>
<td>char</td>
<td>[基本类型] 基本多语种平面中的Unicode代码点 UTF-16</td>
</tr>
<tr>
<td>D</td>
<td>double</td>
<td>[基本类型] 双精度浮点数</td>
</tr>
<tr>
<td>F</td>
<td>float</td>
<td>[基本类型] 单精度浮点数</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>[基本类型] 整型数</td>
</tr>
<tr>
<td>J</td>
<td>long</td>
<td>[基本类型] 长整数</td>
</tr>
<tr>
<td>S</td>
<td>short</td>
<td>[基本类型] 有符号短整数</td>
</tr>
<tr>
<td>Z</td>
<td>boolean</td>
<td>[基本类型] 布尔值true/false</td>
</tr>
<tr>
<td>L ClassName;</td>
<td>L ClassName;</td>
<td>[对象类型] ClassName类的实例</td>
</tr>
<tr>
<td>[</td>
<td>reference</td>
<td>[数组类型] 一维数组</td>
</tr>
</tbody></table>
<h3 id="1-6-Method-信息"><a href="#1-6-Method-信息" class="headerlink" title="1.6 Method 信息"></a>1.6 Method 信息</h3><p>表示方法数量，本类为 2<br>0000520 21 00 05 00 06 00 00 00 00 <strong>00 02</strong> 00 01 00 07 00<br>一个方法由 访问修饰符，名称，参数描述，方法属性数量，方法属性组成</p>
<ul>
<li><p>红色代表访问修饰符（本类中是 public）</p>
</li>
<li><p>蓝色代表引用了常量池 #07 项作为方法名称</p>
</li>
<li><p>绿色代表引用了常量池 #08 项作为方法参数描述</p>
</li>
<li><p>黄色代表方法属性数量，本方法是 1</p>
</li>
<li><p>红色代表方法属性</p>
<ul>
<li><p>00 09 表示引用了常量池 #09 项，发现是【Code】属性</p>
</li>
<li><p>00 00 00 1d 表示此属性的长度是 29</p>
</li>
<li><p>00 01 表示【操作数栈】最大深度</p>
</li>
<li><p>00 01 表示【局部变量表】最大槽（slot）数</p>
</li>
<li><p>00 00 00 05 表示字节码长度，本例是 5</p>
</li>
<li><p>2a b7 00 01 b1 是字节码指令</p>
</li>
<li><p>00 00 00 01 表示方法细节属性数量，本例是 1</p>
</li>
<li><p>00 0a 表示引用了常量池 #10 项，发现是【LineNumberTable】属性</p>
<ul>
<li>00 00 00 06 表示此属性的总长度，本例是 6</li>
<li>00 01 表示【LineNumberTable】长度</li>
<li>00 00 表示【字节码】行号 </li>
<li>00 06 表示【java 源码】行号<br>00 00 表示局部变量占有的槽位（slot）编号，本例是 0</li>
</ul>
<p>0000520 21 00 05 00 06 00 00 00 00 00 02 <font color = red>00 01</font> <font color = blue>00 07</font> <font color = green>00</font><br>0000540 <font color = green>08</font> <font color = yellow>00 01</font> <font color = red >00 09 00 00 00 1d 00 01 00 01 00 00 00</font><br>0000560 <font color = red>05 2a b7 00 01 b1 00 00 00 01 00 0a 00 00 00 06</font><br>0000600 <font color = red>00 01 00 00 00 06 00 09 00 0b 00 0c 00 02 00 09</font></p>
</li>
</ul>
</li>
</ul>
<h3 id="1-7附加属性"><a href="#1-7附加属性" class="headerlink" title="1.7附加属性"></a>1.7附加属性</h3><p>00 01 表示附加属性数量<br>00 0f表示引用了常量池 #15项，即【SourceFile】<br>00 00 00 02 表示此属性的长度<br>00 10 表示引用了常量池 #16项，即【HelloWorld.java】</p>
<p>0000700 00 0e 00 00 <strong>00 01 00 0f 00 00 00 02 00 10</strong></p>
<p>参考文献<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html</a></p>
<h2 id="2-字节码指令"><a href="#2-字节码指令" class="headerlink" title="2.字节码指令"></a>2.字节码指令</h2><h3 id="1原始java代码"><a href="#1原始java代码" class="headerlink" title="1原始java代码"></a>1原始java代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 演示 字节码指令 和 操作数栈、常量池的关系</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> b = Short.MAX_VALUE + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> c = a + b;</span><br><span class="line">        System.out.println(c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-编译后的字节码文件"><a href="#2-编译后的字节码文件" class="headerlink" title="2.编译后的字节码文件"></a>2.编译后的字节码文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/ByteCodeTest.class</span><br><span class="line">  Last modified <span class="number">2021</span>-<span class="number">7</span>-<span class="number">18</span>; size <span class="number">499</span> bytes</span><br><span class="line">  MD5 checksum fb5d8bf20fff84038da0dbef59839a5c</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteCodeTest</span></span></span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #7.#22         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 = Class              #23            // java/lang/Short</span><br><span class="line">   #3 = Integer            32768</span><br><span class="line">   #4 = Fieldref           #24.#25        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   #5 = Methodref          #26.#27        // java/io/PrintStream.println:(I)V</span><br><span class="line">   #6 = Class              #28            // ByteCodeTest</span><br><span class="line">   #7 = Class              #29            // java/lang/Object</span><br><span class="line">   #8 = Utf8               &lt;init&gt;</span><br><span class="line">   #9 = Utf8               ()V</span><br><span class="line">  #10 = Utf8               Code</span><br><span class="line">  #11 = Utf8               LocalVariableTable</span><br><span class="line">  #12 = Utf8               this</span><br><span class="line">  #13 = Utf8               LByteCodeTest;</span><br><span class="line">  #14 = Utf8               main</span><br><span class="line">  #15 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  #16 = Utf8               args</span><br><span class="line">  #17 = Utf8               [Ljava/lang/String;</span><br><span class="line">  #18 = Utf8               a</span><br><span class="line">  #19 = Utf8               I</span><br><span class="line">  #20 = Utf8               b</span><br><span class="line">  #21 = Utf8               c</span><br><span class="line">  #22 = NameAndType        #8:#9          // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  #23 = Utf8               java/lang/Short</span><br><span class="line">  #24 = Class              #30            // java/lang/System</span><br><span class="line">  #25 = NameAndType        #31:#32        // out:Ljava/io/PrintStream;</span><br><span class="line">  #26 = Class              #33            // java/io/PrintStream</span><br><span class="line">  #27 = NameAndType        #34:#35        // println:(I)V</span><br><span class="line">  #28 = Utf8               ByteCodeTest</span><br><span class="line">  #29 = Utf8               java/lang/Object</span><br><span class="line">  #30 = Utf8               java/lang/System</span><br><span class="line">  #31 = Utf8               out</span><br><span class="line">  #32 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  #33 = Utf8               java/io/PrintStream</span><br><span class="line">  #34 = Utf8               println</span><br><span class="line">  #35 = Utf8               (I)V</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ByteCodeTest</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   LByteCodeTest;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: bipush        <span class="number">10</span></span><br><span class="line">         <span class="number">2</span>: istore_1</span><br><span class="line">         3: ldc           #3                  // int 32768</span><br><span class="line">         <span class="number">5</span>: istore_2</span><br><span class="line">         <span class="number">6</span>: iload_1</span><br><span class="line">         <span class="number">7</span>: iload_2</span><br><span class="line">         <span class="number">8</span>: iadd</span><br><span class="line">         <span class="number">9</span>: istore_3</span><br><span class="line">        10: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        <span class="number">13</span>: iload_3</span><br><span class="line">        14: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V</span><br><span class="line">        <span class="number">17</span>: <span class="keyword">return</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>      <span class="number">18</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">            <span class="number">3</span>      <span class="number">15</span>     <span class="number">1</span>     a   I</span><br><span class="line">            <span class="number">6</span>      <span class="number">12</span>     <span class="number">2</span>     b   I</span><br><span class="line">           <span class="number">10</span>       <span class="number">8</span>     <span class="number">3</span>     c   I</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-常量池载入运行时"><a href="#3-常量池载入运行时" class="headerlink" title="3.常量池载入运行时"></a>3.常量池载入运行时</h3><img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718132420364.png" alt="image-20210718132420364" style="zoom:67%;" />

<p>short 类型的数字和方法的字节码存储在一起，当大于short的最大值时，存储在常量池中</p>
<h3 id="4-方法字节码载入方法区"><a href="#4-方法字节码载入方法区" class="headerlink" title="4.方法字节码载入方法区"></a>4.方法字节码载入方法区</h3><img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718132546669.png" alt="image-20210718132546669" style="zoom:67%;" />

<h3 id="5-main-线程开始运行，分配栈帧内存"><a href="#5-main-线程开始运行，分配栈帧内存" class="headerlink" title="5.main 线程开始运行，分配栈帧内存"></a>5.main 线程开始运行，分配栈帧内存</h3><p>（stack=2，locals=4）</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718133746939.png" alt="image-20210718133746939" style="zoom:67%;" />

<h3 id="6-执行引擎开始执行字节码"><a href="#6-执行引擎开始执行字节码" class="headerlink" title="6.执行引擎开始执行字节码"></a>6.执行引擎开始执行字节码</h3><p><strong>bipush 10</strong></p>
<ul>
<li><p>将一个 byte 压入操作数栈（其长度会补齐 4 个字节），类似的指令还有</p>
</li>
<li><p>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节）</p>
</li>
<li><p>ldc 将一个 int 压入操作数栈</p>
</li>
<li><p>ldc2_w 将一个 long 压入操作数栈（分两次压入，因为 long 是 8 个字节）</p>
</li>
<li><p>这里小的数字都是和字节码指令存在一起，超过 short 范围的数字存入了常量池</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140103397.png" alt="image-20210718140103397" style="zoom:67%;" /></li>
</ul>
<p><strong>istore_1</strong></p>
<ul>
<li>将操作数栈顶数据弹出，存入局部变量表的 slot 1<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140126212.png" alt="image-20210718140126212" style="zoom:67%;" /></li>
</ul>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140130985.png" alt="image-20210718140130985" style="zoom:67%;" />

<p><strong>ldc #3</strong></p>
<ul>
<li>从常量池加载 #3 数据到操作数栈</li>
<li>注意 Short.MAX_VALUE 是 32767，所以 32768 = Short.MAX_VALUE + 1 实际是在编译期间计算<br>好的</li>
</ul>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140153638.png" alt="image-20210718140153638" style="zoom:67%;" />

<p><strong>istore_2</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140207715.png" alt="image-20210718140207715" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140212852.png" alt="image-20210718140212852" style="zoom:67%;" />

<p><strong>iload_1</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140229738.png" alt="image-20210718140229738" style="zoom:67%;" />

<p><strong>iload_2</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718140235416.png" alt="image-20210718140235416" style="zoom:67%;" />

<p><strong>iadd</strong></p>
<p>从栈中弹出两个操作数 将他们的和放入操作数栈中</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144038345.png" alt="image-20210718144038345" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144203337.png" alt="image-20210718144203337" style="zoom:67%;" />

<p><strong>istore_3</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144805204.png" alt="image-20210718144805204" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144813264.png" alt="image-20210718144813264" style="zoom:67%;" />

<p><strong>getstatic #4</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144855717.png" alt="image-20210718144855717" style="zoom:67%;" />

<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144925709.png" alt="image-20210718144925709" style="zoom:67%;" />

<p><strong>iload_3</strong></p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718144944047.png" alt="image-20210718144944047" style="zoom: 67%;" />

<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145000294.png" alt="image-20210718145000294" style="zoom:67%;" />

<p><strong>invokevirtual #5</strong></p>
<ul>
<li>找到常量池 #5 项</li>
<li>定位到方法区 java/io/PrintStream.println:(I)V 方法</li>
<li>生成新的栈帧（分配 locals、stack等）</li>
<li>传递参数，执行新栈帧中的字节码</li>
</ul>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145050984.png" alt="image-20210718145050984" style="zoom:67%;" />

<ul>
<li>执行完毕，弹出栈帧</li>
<li>清除 main 操作数栈内容</li>
</ul>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718145920462.png" alt="image-20210718145920462" style="zoom:67%;" />



<p><strong>return</strong><br>完成 main 方法调用，弹出 main 栈帧<br>程序结束</p>
<h3 id="7构造方法"><a href="#7构造方法" class="headerlink" title="7构造方法"></a>7构造方法</h3><h4 id="1-lt-cinit-gt-V"><a href="#1-lt-cinit-gt-V" class="headerlink" title="1. &lt;cinit&gt;()V"></a>1. <strong>&lt;cinit&gt;()V</strong></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        i = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译器会按从上至下的顺序，收集所有 static 静态代码块和静态成员赋值的代码，合并为一个特殊的方法 &lt;cinit&gt;()V ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: bipush <span class="number">10</span></span><br><span class="line">2: putstatic #2 // Field i:I</span><br><span class="line"><span class="number">5</span>: bipush <span class="number">20</span></span><br><span class="line">7: putstatic #2 // Field i:I</span><br><span class="line"><span class="number">10</span>: bipush <span class="number">30</span></span><br><span class="line">12: putstatic #2 // Field i:I</span><br><span class="line"><span class="number">15</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>&lt;cinit&gt;()V 方法会在类加载的初始化阶段被调用</p>
<h4 id="2-lt-init-gt-V"><a href="#2-lt-init-gt-V" class="headerlink" title="2. &lt;init&gt;()V"></a>2. <strong>&lt;init&gt;()V</strong></h4><p>编译器会按从上至下的顺序，收集所有 {} 代码块和成员变量赋值的代码，形成新的构造方法，但原始构造方法内的代码总是在最后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String a = <span class="string">&quot;s1&quot;</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        b = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> b = <span class="number">10</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        a = <span class="string">&quot;s2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(String a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">        <span class="keyword">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Test d = <span class="keyword">new</span> Test(<span class="string">&quot;s3&quot;</span>, <span class="number">30</span>);</span><br><span class="line">        System.out.println(d.a);</span><br><span class="line">        System.out.println(d.b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">(java.lang.String, <span class="keyword">int</span>)</span></span>;</span><br><span class="line">    descriptor: (Ljava/lang/String;I)V</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">3</span>, args_size=<span class="number">3</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         1: invokespecial #1                  // super.&lt;init&gt;()V</span><br><span class="line">         <span class="number">4</span>: aload_0</span><br><span class="line">         5: ldc           #2                  // &lt;- &quot;s1&quot;</span><br><span class="line">         7: putfield      #3                  // -&gt; this.a</span><br><span class="line">        <span class="number">10</span>: aload_0</span><br><span class="line">        <span class="number">11</span>: bipush        <span class="number">20</span>				  <span class="comment">// &lt;- 20</span></span><br><span class="line">        13: putfield      #4                  // -&gt; this.b</span><br><span class="line">        <span class="number">16</span>: aload_0</span><br><span class="line">        <span class="number">17</span>: bipush        <span class="number">10</span>				  <span class="comment">// &lt;- 10</span></span><br><span class="line">        19: putfield      #4                  // -&gt; this.b</span><br><span class="line">        <span class="number">22</span>: aload_0</span><br><span class="line">        23: ldc           #5                  // &lt;- &quot;s2&quot;</span><br><span class="line">        25: putfield      #3                  // -&gt; this.a</span><br><span class="line">        <span class="number">28</span>: aload_0							  <span class="comment">// ------------------------------</span></span><br><span class="line">        <span class="number">29</span>: aload_1							  <span class="comment">// &lt;- slot 1(a) &quot;s3&quot;            |</span></span><br><span class="line">        30: putfield      #3                  // -&gt; this.a                    |</span><br><span class="line">        <span class="number">33</span>: aload_0															  |</span><br><span class="line">        <span class="number">34</span>: iload_2							  <span class="comment">// &lt;- slot 2(b) 30              |</span></span><br><span class="line">        35: putfield      #4                  // -&gt; this.b --------------------</span><br><span class="line">        <span class="number">38</span>: <span class="keyword">return</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>      <span class="number">39</span>     <span class="number">0</span>  <span class="keyword">this</span>   LTest;</span><br><span class="line">            <span class="number">0</span>      <span class="number">39</span>     <span class="number">1</span>     a   Ljava/lang/String;</span><br><span class="line">            <span class="number">0</span>      <span class="number">39</span>     <span class="number">2</span>     b   I</span><br></pre></td></tr></table></figure>

<h3 id="8-方法调用"><a href="#8-方法调用" class="headerlink" title="8. 方法调用"></a>8. 方法调用</h3><p>看一下几种不同的方法调用对应的字节码指令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Test t = <span class="keyword">new</span> Test();</span><br><span class="line">        t.test1();</span><br><span class="line">        t.test2();</span><br><span class="line">        t.test3();</span><br><span class="line">        t.test4();</span><br><span class="line">        Test.test4();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="静态绑定和动态绑定"><a href="#静态绑定和动态绑定" class="headerlink" title="静态绑定和动态绑定"></a>静态绑定和动态绑定</h4><ul>
<li><p>invokespecial invokestatic 属于<strong>静态绑定</strong> 是在生成字节码的时候已经知道调哪个类的哪个方法了 因为final 方法 私有方法 构造方法 static 方法 都是能唯一确定的 </p>
</li>
<li><p>invokevirtual 和 invokeinterface 是<strong>动态绑定</strong> 普通的public方法是可以重写的在编译期间并不能确定调用哪个对象的哪个方法 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   0: new           #2                  // class Test</span><br><span class="line">   <span class="number">3</span>: dup</span><br><span class="line">   4: invokespecial #3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   <span class="number">7</span>: astore_1</span><br><span class="line">   <span class="number">8</span>: aload_1</span><br><span class="line">   9: invokespecial #4                  // Method test1:()V</span><br><span class="line">  <span class="number">12</span>: aload_1</span><br><span class="line">  13: invokespecial #5                  // Method test2:()V</span><br><span class="line">  <span class="number">16</span>: aload_1</span><br><span class="line">  17: invokevirtual #6                  // Method test3:()V</span><br><span class="line">  <span class="number">20</span>: aload_1</span><br><span class="line">  <span class="number">21</span>: pop</span><br><span class="line">  22: invokestatic  #7                  // Method test4:()V</span><br><span class="line">  25: invokestatic  #7                  // Method test4:()V</span><br><span class="line">  <span class="number">28</span>: <span class="keyword">return</span></span><br><span class="line">LocalVariableTable:</span><br><span class="line">  Start  Length  Slot  Name   Signature</span><br><span class="line">      <span class="number">0</span>      <span class="number">29</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">      <span class="number">8</span>      <span class="number">21</span>     <span class="number">1</span>     t   LTest;</span><br></pre></td></tr></table></figure>

<ul>
<li>new 是创建【对象】，给对象分配堆内存，执行成功会将【对象引用】压入操作数栈</li>
<li>dup 是赋值操作数栈栈顶的内容，本例即为【对象引用】，为什么需要两份引用呢，一个是要配合 invokespecial 调用该对象的构造方法 “&lt;init&gt;”:()V （会消耗掉栈顶一个引用），另一个要配合 astore_1 赋值给局部变量</li>
<li>最终方法（final），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</li>
<li>普通成员方法是由 invokevirtual 调用，属于动态绑定，即支持多态</li>
<li>成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</li>
<li>比较有意思的是 d.test4(); 是通过【对象引用】调用一个静态方法，可以看到在调用invokestatic 之前执行了 pop 指令，把【对象引用】从操作数栈弹掉了</li>
<li>还有一个执行 invokespecial 的情况是通过 super 调用父类方法</li>
</ul>
<h3 id="9-多态的原理"><a href="#9-多态的原理" class="headerlink" title="9.多态的原理"></a>9.多态的原理</h3><h4 id="1-使用HSDB查看对象地址"><a href="#1-使用HSDB查看对象地址" class="headerlink" title="1. 使用HSDB查看对象地址"></a>1. 使用HSDB查看对象地址</h4><p>进入命令行 使用<code>java -cp %JAVA_HOME%/lib/sa-jdi.jar sun.jvm.hotspot.HSDB</code> 运行HSDB attach进程ID</p>
<p>输入 <code>select d from org.example.test.Dog d</code> 点击 Execute 执行</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220509988.png" alt="image-20210719220509988" style="zoom:50%;" />

<h4 id="2-查看对象内存结构"><a href="#2-查看对象内存结构" class="headerlink" title="2.查看对象内存结构"></a>2.查看对象内存结构</h4><p>点击超链接可以看到对象的内存结构，此对象没有任何属性，因此只有对象头的 16 字节，前 8 字节是<br>MarkWord，后 8 字节就是对象的 Class 指针,但目前看不到它的实际地址</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220732187.png" alt="image-20210719220732187" style="zoom:50%;" />

<h4 id="3-查看对象-Class-的内存地址"><a href="#3-查看对象-Class-的内存地址" class="headerlink" title="3.查看对象 Class 的内存地址"></a>3.查看对象 Class 的内存地址</h4><p>可以通过 Windows -&gt; Console 进入命令行模式，执行<code>mem 0x000000076e39eb50 2</code></p>
<p>mem 有两个参数，参数 1 是对象地址，参数 2 是查看 2 行（即 16 字节）</p>
<p>结果中第二行 0x00000000f800c1c1 即为 Class 的内存地址</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719220937979.png" alt="image-20210719220937979" style="zoom:50%;" />

<h4 id="4-查看类的-vtable"><a href="#4-查看类的-vtable" class="headerlink" title="4.查看类的 vtable"></a>4.查看类的 vtable</h4><p>法1 ：Alt+R 进入 Inspector 工具，输入刚才的 Class 内存地址 </p>
<p>法2：Tools -&gt; Class Browser 输入 Dog 查找，可以得到相同的结果</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719221549539.png" alt="image-20210719221549539" style="zoom:50%;" />

<p>无论通过哪种方法，都可以找到 Dog Class 的 vtable 长度为 6，意思就是 Dog 类有 6 个虚方法（多态<br>相关的，final，static 不会列入）<br>那么这 6 个方法都是谁呢？从 Class 的起始地址开始算，偏移 0x1b8 就是 vtable 的起始地址，进行计<br>算得到：0X7C0060FC0</p>
<p>通过 Windows -&gt; Console 进入命令行模式，执行</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719221815476.png" alt="image-20210719221815476" style="zoom:50%;" />

<p>就得到了 6 个虚方法的入口地址</p>
<h4 id="5-验证方法地址"><a href="#5-验证方法地址" class="headerlink" title="5.验证方法地址"></a>5.验证方法地址</h4><p>通过 Tools -&gt; Class Browser 查看每个类的方法定义，比较可知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Dog - <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span> @0x00000151f3423658</span>;</span><br><span class="line">Animal - <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">toString</span><span class="params">()</span> @0x00000151f3423088</span>;</span><br><span class="line">Object - <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> @0x00000151f3020c10</span>;</span><br><span class="line">Object - <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(java.lang.Object)</span> @0x00000151f30206e8</span>;</span><br><span class="line">Object - <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> @0x00000151f3020640</span>;</span><br><span class="line">Object - <span class="keyword">protected</span> <span class="keyword">native</span> java.lang.<span class="function">Object <span class="title">clone</span><span class="params">()</span> @0x00000151f3020778</span>;</span><br></pre></td></tr></table></figure>

<h4 id="6-小结"><a href="#6-小结" class="headerlink" title="6.小结"></a>6.小结</h4><p>当执行 invokevirtual 指令时，</p>
<ol>
<li>先通过栈帧中的对象引用找到对象</li>
<li>分析对象头，找到对象的实际 Class</li>
<li>Class 结构中有 vtable，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li>
<li>查表得到方法的具体地址</li>
<li>执行方法的字节码</li>
</ol>
<h3 id="10-异常处理"><a href="#10-异常处理" class="headerlink" title="10.异常处理"></a>10.异常处理</h3><h4 id="1-try-catch"><a href="#1-try-catch" class="headerlink" title="1.try-catch"></a>1.try-catch</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        i = <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        i = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">  descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">  flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack&#x3D;1, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">       0: iconst_0</span><br><span class="line">       1: istore_1</span><br><span class="line">       2: bipush        10</span><br><span class="line">       4: istore_1</span><br><span class="line">       5: goto          12</span><br><span class="line">       8: astore_2</span><br><span class="line">       9: bipush        20</span><br><span class="line">      11: istore_1</span><br><span class="line">      12: return</span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">           2     5     8   Class java&#x2F;lang&#x2F;Exception</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          9       3     2     e   Ljava&#x2F;lang&#x2F;Exception;</span><br><span class="line">          0      13     0  args   [Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">          2      11     1     i   I</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到多出来一个 Exception table 的结构，[from, to) 是前闭后开的检测范围，一旦这个范围内的字节码执行出现异常，则通过 type 匹配异常类型，如果一致，进入 target 所指示行号</li>
<li>8 行的字节码指令 astore_2 是将异常对象引用存入局部变量表的 slot 2 位置</li>
</ul>
<h4 id="2-多个-single-catch-块的情况"><a href="#2-多个-single-catch-块的情况" class="headerlink" title="2.多个 single-catch 块的情况"></a>2.多个 single-catch 块的情况</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        i = <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ArithmeticException e) &#123;</span><br><span class="line">        i = <span class="number">30</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">        i = <span class="number">40</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        i = <span class="number">50</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">  descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">  flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">  Code:</span><br><span class="line">    stack&#x3D;1, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">       0: iconst_0</span><br><span class="line">       1: istore_1</span><br><span class="line">       2: bipush        10</span><br><span class="line">       4: istore_1</span><br><span class="line">       5: goto          26</span><br><span class="line">       8: astore_2</span><br><span class="line">       9: bipush        30</span><br><span class="line">      11: istore_1</span><br><span class="line">      12: goto          26</span><br><span class="line">      15: astore_2</span><br><span class="line">      16: bipush        40</span><br><span class="line">      18: istore_1</span><br><span class="line">      19: goto          26</span><br><span class="line">      22: astore_2</span><br><span class="line">      23: bipush        50</span><br><span class="line">      25: istore_1</span><br><span class="line">      26: return</span><br><span class="line">    Exception table:</span><br><span class="line">       from    to  target type</span><br><span class="line">           2     5     8   Class java&#x2F;lang&#x2F;ArithmeticException</span><br><span class="line">           2     5    15   Class java&#x2F;lang&#x2F;NullPointerException</span><br><span class="line">           2     5    22   Class java&#x2F;lang&#x2F;Exception</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          9       3     2     e   Ljava&#x2F;lang&#x2F;ArithmeticException;</span><br><span class="line">         16       3     2     e   Ljava&#x2F;lang&#x2F;NullPointerException;</span><br><span class="line">         23       3     2     e   Ljava&#x2F;lang&#x2F;Exception;</span><br><span class="line">          0      27     0  args   [Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">          2      25     1     i   I</span><br></pre></td></tr></table></figure>

<ul>
<li>因为异常出现时，只能进入 Exception table 中一个分支，所以局部变量表 slot 2 位置被共用</li>
</ul>
<h4 id="3-multi-catch-的情况"><a href="#3-multi-catch-的情况" class="headerlink" title="3.multi-catch 的情况"></a>3.multi-catch 的情况</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method test = Test.class.getMethod(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">            test.invoke(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException | IllegalAccessException |</span><br><span class="line">                 InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">3</span>, locals=<span class="number">2</span>, args_size=<span class="number">1</span></span><br><span class="line">         0: ldc           #2                  // class Test</span><br><span class="line">         2: ldc           #3                  // String test</span><br><span class="line">         <span class="number">4</span>: iconst_0</span><br><span class="line">         5: anewarray     #4                  // class java/lang/Class</span><br><span class="line">         8: invokevirtual #5                  // Method java/lang/Class.getMethod:(Ljava/lang/String;[Ljava/lang/Class;)Ljava/lang/reflect/Method;</span><br><span class="line">        <span class="number">11</span>: astore_1</span><br><span class="line">        <span class="number">12</span>: aload_1</span><br><span class="line">        <span class="number">13</span>: aconst_null</span><br><span class="line">        <span class="number">14</span>: iconst_0</span><br><span class="line">        15: anewarray     #6                  // class java/lang/Object</span><br><span class="line">        18: invokevirtual #7                  // Method java/lang/reflect/Method.invoke:(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object;</span><br><span class="line">        <span class="number">21</span>: pop</span><br><span class="line">        <span class="number">22</span>: goto          <span class="number">30</span></span><br><span class="line">        <span class="number">25</span>: astore_1</span><br><span class="line">        <span class="number">26</span>: aload_1</span><br><span class="line">        27: invokevirtual #11                 // Method java/lang/ReflectiveOperationException.printStackTrace:()V</span><br><span class="line">        <span class="number">30</span>: <span class="keyword">return</span></span><br><span class="line">      Exception table:</span><br><span class="line">         from    to  target type</span><br><span class="line">             <span class="number">0</span>    <span class="number">22</span>    <span class="number">25</span>   Class java/lang/NoSuchMethodException</span><br><span class="line">             <span class="number">0</span>    <span class="number">22</span>    <span class="number">25</span>   Class java/lang/IllegalAccessException</span><br><span class="line">             <span class="number">0</span>    <span class="number">22</span>    <span class="number">25</span>   Class java/lang/reflect/InvocationTargetException</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">           <span class="number">12</span>      <span class="number">10</span>     <span class="number">1</span>  test   Ljava/lang/reflect/Method;</span><br><span class="line">           <span class="number">26</span>       <span class="number">4</span>     <span class="number">1</span>     e   Ljava/lang/ReflectiveOperationException;</span><br><span class="line">            <span class="number">0</span>      <span class="number">31</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br></pre></td></tr></table></figure>

<h4 id="4-finally"><a href="#4-finally" class="headerlink" title="4.finally"></a>4.finally</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        i = <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        i = <span class="number">20</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        i = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">   descriptor: ([Ljava/lang/String;)V</span><br><span class="line">   flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">   Code:</span><br><span class="line">     stack=<span class="number">1</span>, locals=<span class="number">4</span>, args_size=<span class="number">1</span></span><br><span class="line">        <span class="number">0</span>: iconst_0</span><br><span class="line">        <span class="number">1</span>: istore_1      				<span class="comment">// 0 -&gt; i</span></span><br><span class="line">        <span class="number">2</span>: bipush        <span class="number">10</span>			<span class="comment">// try --------------------------------------</span></span><br><span class="line">        <span class="number">4</span>: istore_1					<span class="comment">// 10 -&gt; i									|</span></span><br><span class="line">        <span class="number">5</span>: bipush        <span class="number">30</span>			<span class="comment">// finally									|</span></span><br><span class="line">        <span class="number">7</span>: istore_1					<span class="comment">// 30 -&gt; i									|</span></span><br><span class="line">        <span class="number">8</span>: goto          <span class="number">27</span>			<span class="comment">// return -----------------------------------</span></span><br><span class="line">       <span class="number">11</span>: astore_2					<span class="comment">// catch Exceptin -&gt; e ----------------------</span></span><br><span class="line">       <span class="number">12</span>: bipush        <span class="number">20</span>			<span class="comment">//											|</span></span><br><span class="line">       <span class="number">14</span>: istore_1					<span class="comment">// 20 -&gt; i									|</span></span><br><span class="line">       <span class="number">15</span>: bipush        <span class="number">30</span>			<span class="comment">// finally									|</span></span><br><span class="line">       <span class="number">17</span>: istore_1					<span class="comment">// 30 -&gt; i									|	</span></span><br><span class="line">       <span class="number">18</span>: goto          <span class="number">27</span>			<span class="comment">// return -----------------------------------</span></span><br><span class="line">       <span class="number">21</span>: astore_3					<span class="comment">// catch any -&gt; slot 3 ----------------------</span></span><br><span class="line">       <span class="number">22</span>: bipush        <span class="number">30</span>			<span class="comment">// finally									|</span></span><br><span class="line">       <span class="number">24</span>: istore_1					<span class="comment">// 30 -&gt; i									|</span></span><br><span class="line">       <span class="number">25</span>: aload_3						<span class="comment">// &lt;- slot 3								|</span></span><br><span class="line">       <span class="number">26</span>: athrow						<span class="comment">// throw ------------------------------------</span></span><br><span class="line">       <span class="number">27</span>: <span class="keyword">return</span>	</span><br><span class="line">     Exception table:</span><br><span class="line">        from    to  target type</span><br><span class="line">            <span class="number">2</span>     <span class="number">5</span>    <span class="number">11</span>   Class java/lang/Exception</span><br><span class="line">            <span class="number">2</span>     <span class="number">5</span>    <span class="number">21</span>   any		<span class="comment">// 剩余的异常类型，比如 Error</span></span><br><span class="line">           <span class="number">11</span>    <span class="number">15</span>    <span class="number">21</span>   any		<span class="comment">// 剩余的异常类型，比如 Error</span></span><br><span class="line">     LocalVariableTable:</span><br><span class="line">       Start  Length  Slot  Name   Signature</span><br><span class="line">          <span class="number">12</span>       <span class="number">3</span>     <span class="number">2</span>     e   Ljava/lang/Exception;</span><br><span class="line">           <span class="number">0</span>      <span class="number">28</span>     <span class="number">0</span>  args   [Ljava/lang/String;</span><br><span class="line">           <span class="number">2</span>      <span class="number">26</span>     <span class="number">1</span>     i   I</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 finally 中的代码被复制了 3 份，分别放入 try 流程，catch 流程以及 catch 剩余的异常类型流程</li>
</ul>
<h4 id="5-练习-finally-面试题"><a href="#5-练习-finally-面试题" class="headerlink" title="5 练习 - finally 面试题"></a>5 练习 - finally 面试题</h4><h5 id="1-finally-出现了-return"><a href="#1-finally-出现了-return" class="headerlink" title="1. finally 出现了 return"></a>1. finally 出现了 return</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">	descriptor: ()I</span><br><span class="line">	flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">	Code:</span><br><span class="line">		stack=<span class="number">1</span>, locals=<span class="number">2</span>, args_size=<span class="number">0</span></span><br><span class="line">		<span class="number">0</span>: bipush <span class="number">10</span>		 <span class="comment">// &lt;- 10 放入栈顶</span></span><br><span class="line">        <span class="number">2</span>: istore_0			 <span class="comment">// 10 -&gt; slot 0 (从栈顶移除了)</span></span><br><span class="line">        <span class="number">3</span>: bipush <span class="number">20</span> 		 <span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">        <span class="number">5</span>: ireturn 			 <span class="comment">// 返回栈顶 int(20)</span></span><br><span class="line">        <span class="number">6</span>: astore_1     	 <span class="comment">// catch any -&gt; slot 1</span></span><br><span class="line">        <span class="number">7</span>: bipush <span class="number">20</span> 		 <span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">        <span class="number">9</span>: ireturn 		     <span class="comment">// 返回栈顶 int(20)</span></span><br><span class="line">     Exception table:</span><br><span class="line">        from    to  target type</span><br><span class="line">            <span class="number">0</span>     <span class="number">3</span>     <span class="number">6</span>   any</span><br></pre></td></tr></table></figure>

<ul>
<li><p>由于 finally 中的 ireturn 被插入了所有可能的流程，因此返回结果肯定以 finally 的为准</p>
</li>
<li><p>至于字节码中第 2 行，似乎没啥用，且留个伏笔，看下个例子</p>
</li>
<li><p>跟上例中的 finally 相比，发现没有 athrow 了，这告诉我们：<strong>如果在 finally 中出现了 return，会吞掉异常</strong>，可以试一下下面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="2-finally-对返回值影响"><a href="#2-finally-对返回值影响" class="headerlink" title="2.finally 对返回值影响"></a>2.finally 对返回值影响</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        i = <span class="number">20</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">test</span><span class="params">()</span></span>;</span><br><span class="line">	descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">        stack=<span class="number">1</span>, locals=<span class="number">3</span>, args_size=<span class="number">0</span></span><br><span class="line">            <span class="number">0</span>: bipush <span class="number">10</span> 				<span class="comment">// &lt;- 10 放入栈顶</span></span><br><span class="line">            <span class="number">2</span>: istore_0 				<span class="comment">// 10 -&gt; i</span></span><br><span class="line">            <span class="number">3</span>: iload_0 					<span class="comment">// &lt;- i(10)</span></span><br><span class="line">            <span class="number">4</span>: istore_1 				<span class="comment">// 10 -&gt; slot 1，暂存至 slot 1，目的是为了固定返回值</span></span><br><span class="line">            <span class="number">5</span>: bipush <span class="number">20</span> 				<span class="comment">// &lt;- 20 放入栈顶</span></span><br><span class="line">            <span class="number">7</span>: istore_0 				<span class="comment">// 20 -&gt; i</span></span><br><span class="line">            <span class="number">8</span>: iload_1 					<span class="comment">// &lt;- slot 1(10) 载入 slot 1 暂存的值</span></span><br><span class="line">            <span class="number">9</span>: ireturn 					<span class="comment">// 返回栈顶的 int(10)</span></span><br><span class="line">            <span class="number">10</span>: astore_2</span><br><span class="line">            <span class="number">11</span>: bipush <span class="number">20</span></span><br><span class="line">            <span class="number">13</span>: istore_0</span><br><span class="line">            <span class="number">14</span>: aload_2</span><br><span class="line">            <span class="number">15</span>: athrow</span><br><span class="line">		Exception table:</span><br><span class="line">           from    to  target type</span><br><span class="line">               <span class="number">3</span>    <span class="number">5</span>     <span class="number">10</span>   any</span><br><span class="line">        LocalVariableTable:</span><br><span class="line">            Start  Length  Slot  Name   Signature</span><br><span class="line">                <span class="number">3</span>      <span class="number">13</span>     <span class="number">0</span>     i       I</span><br></pre></td></tr></table></figure>

<ul>
<li>只要finally块没有return语句 就不会改变返回值 </li>
</ul>
<h2 id="3-编译期处理"><a href="#3-编译期处理" class="headerlink" title="3.编译期处理"></a>3.编译期处理</h2><h4 id="1-枚举类"><a href="#1-枚举类" class="headerlink" title="1.枚举类"></a>1.枚举类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Sex</span> </span>&#123;</span><br><span class="line">    MALE, FEMALE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>转换后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sex</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">Sex</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex MALE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex FEMALE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Sex[] $VALUES;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        MALE = <span class="keyword">new</span> Sex(<span class="string">&quot;MALE&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        FEMALE = <span class="keyword">new</span> Sex(<span class="string">&quot;FEMALE&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        $VALUES = <span class="keyword">new</span> Sex[]&#123;MALE, FEMALE&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Sole constructor. Programmers cannot invoke this constructor.</span></span><br><span class="line"><span class="comment">        * It is for use by code emitted by the compiler in response to</span></span><br><span class="line"><span class="comment">        * enum type declarations.</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> name - The name of this enum constant, which is the identifier</span></span><br><span class="line"><span class="comment">        * used to declare it.</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> ordinal - The ordinal of this enumeration constant (its position</span></span><br><span class="line"><span class="comment">        * in the enum declaration, where the initial constant is</span></span><br><span class="line"><span class="comment">        assigned</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Sex</span><span class="params">(String name, <span class="keyword">int</span> ordinal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, ordinal);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Sex[] values() &#123;</span><br><span class="line">        <span class="keyword">return</span> $VALUES.clone();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Sex <span class="title">valueOf</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Enum.valueOf(Sex.class, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>枚举类继承了Enum类，将枚举定义为私有静态成员变量。</li>
</ul>
<h4 id="2-匿名内部类"><a href="#2-匿名内部类" class="headerlink" title="2. 匿名内部类"></a>2. 匿名内部类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 额外生成的类</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Candy11</span>$1 <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    Candy11$<span class="number">1</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引用局部变量的匿名内部类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Candy11</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;ok:&quot;</span> + x);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 额外生成的类</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Candy11</span>$1 <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> val$x;</span><br><span class="line">    Candy11$<span class="number">1</span>(<span class="keyword">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">this</span>.val$x = x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok:&quot;</span> + <span class="keyword">this</span>.val$x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Candy11</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Candy11$<span class="number">1</span>(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意 这同时解释了为什么匿名内部类引用局部变量时，局部变量必须是 final 的：因为在创建Candy11$1 对象时，将 x 的值赋值给了 Candy11$1 对象的 val属性， 所以x不应该发生变化了，如果变化，那么val$x属性没有机会跟着一起变化了</p>
</blockquote>
<h2 id="4-类加载阶段"><a href="#4-类加载阶段" class="headerlink" title="4.类加载阶段"></a>4.类加载阶段</h2><h3 id="4-1-加载"><a href="#4-1-加载" class="headerlink" title="4.1 加载"></a>4.1 加载</h3><img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210719215926573.png" alt="image-20210719215926573" style="zoom:50%;" />

<ul>
<li>将类的字节码载入方法区中，内部采用 C++ 的 instanceKlass 描述 java 类，它的重要 field 有：<ul>
<li>_java_mirror 即 java 的类镜像，例如对 String 来说，就是 String.class，作用是把 klass 暴露给 java 使用</li>
<li>super 即父类</li>
<li>_fields 即成员变量</li>
<li>methods 即方法</li>
<li>_constants 即常量池</li>
<li>class_loader 即类加载器</li>
<li>_vtable 虚方法表</li>
<li>itable 接口方法表</li>
<li>如果这个类还有父类没有加载，先加载父类</li>
<li>加载和链接可能是交替运行的</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意</p>
<ul>
<li>instanceKlass 这样的【元数据】是存储在方法区（1.8 后的元空间内），但 _java_mirror是存储在堆中</li>
</ul>
</blockquote>
<p><img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210718211545368.png" alt="image-20210718211545368"></p>
<h3 id="4-2链接"><a href="#4-2链接" class="headerlink" title="4.2链接"></a>4.2链接</h3><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>验证类是否符合 JVM规范，安全性检查</p>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>为 static 变量分配空间，设置默认值</p>
<ul>
<li>static 变量在 JDK 7 之前存储于 instanceKlass 末尾，从 JDK 7 开始，存储于 _java_mirror 末尾</li>
<li>static 变量分配空间和赋值是两个步骤，分配空间在准备阶段完成，赋值在初始化阶段完成</li>
<li>如果 static 变量是 final 的基本类型，以及字符串常量，那么编译阶段值就确定了，赋值在准备阶段完成</li>
<li>如果 static 变量是 final 的，但属于引用类型，那么赋值也会在初始化阶段完成</li>
</ul>
<h4 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h4><p>将符号引用转换为直接引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResolveTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; aClass = ResolveTest.class.getClassLoader().loadClass(<span class="string">&quot;org.example.test.C&quot;</span>);</span><br><span class="line"><span class="comment">//        new C();</span></span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    D d = <span class="keyword">new</span> D();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用HSDB查看 当C未初始化时 C的常量池</p>
<table>
<thead>
<tr>
<th>Index</th>
<th>Constant Type</th>
<th>Constant Value</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>JVM_CONSTANT_Methodref</td>
<td>#6 #18</td>
</tr>
<tr>
<td>2</td>
<td>JVM_CONSTANT_UnresolvedClass</td>
<td>org/example/test/D</td>
</tr>
<tr>
<td>3</td>
<td>JVM_CONSTANT_Methodref</td>
<td>#2 #18</td>
</tr>
<tr>
<td>4</td>
<td>JVM_CONSTANT_Fieldref</td>
<td>#5 #20</td>
</tr>
<tr>
<td>5</td>
<td>JVM_CONSTANT_UnresolvedClass</td>
<td>org/example/test/C</td>
</tr>
<tr>
<td>6</td>
<td>JVM_CONSTANT_UnresolvedClass</td>
<td>java/lang/Object</td>
</tr>
</tbody></table>
<p>C初始化后的常量池</p>
<table>
<thead>
<tr>
<th>Index</th>
<th>Constant Type</th>
<th>Constant Value</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>JVM_CONSTANT_Methodref</td>
<td>#6 #18</td>
</tr>
<tr>
<td>2</td>
<td>JVM_CONSTANT_Class</td>
<td><a href="klass=0x00000007c0060c10">class org.example.test.D            @0x00000007c0060c10</a></td>
</tr>
<tr>
<td>3</td>
<td>JVM_CONSTANT_Methodref</td>
<td>#2 #18</td>
</tr>
<tr>
<td>4</td>
<td>JVM_CONSTANT_Fieldref</td>
<td>#5 #20</td>
</tr>
<tr>
<td>5</td>
<td>JVM_CONSTANT_Class</td>
<td><a href="klass=0x00000007c0060a18">class org.example.test.C            @0x00000007c0060a18</a></td>
</tr>
<tr>
<td>6</td>
<td>JVM_CONSTANT_Class</td>
<td><a href="klass=0x00000007c0000f28">public class java.lang.Object            @0x00000007c0000f28</a></td>
</tr>
</tbody></table>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><h5 id="lt-cinit-gt-V-方法"><a href="#lt-cinit-gt-V-方法" class="headerlink" title="&lt;cinit&gt;()V 方法"></a>&lt;cinit&gt;()V 方法</h5><p>初始化即调用 &lt;cinit&gt;()V ，虚拟机会保证这个类的『构造方法』的线程安全</p>
<h5 id="发生的时机"><a href="#发生的时机" class="headerlink" title="发生的时机"></a>发生的时机</h5><p>概括得说，类初始化是【懒惰的】</p>
<ul>
<li>main 方法所在的类，总会被首先初始化</li>
<li>首次访问这个类的静态变量或静态方法时</li>
<li>子类初始化，如果父类还没初始化，会引发子类访问父类的静态变量，只会触发父类的初始化</li>
<li>Class.forName</li>
<li>new 会导致初始化</li>
</ul>
<p>不会导致类初始化的情况</p>
<ul>
<li>访问类的 static final 静态常量（基本类型和字符串）不会触发初始化</li>
<li>类对象.class 不会触发初始化</li>
<li>创建该类的数组不会触发初始化</li>
<li>类加载器的 loadClass 方法</li>
<li>Class.forName 的参数 2 为 false 时</li>
</ul>
<h3 id="5-类加载器"><a href="#5-类加载器" class="headerlink" title="5.类加载器"></a>5.类加载器</h3><table>
<thead>
<tr>
<th>名称</th>
<th>加载路径</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Bootstrap ClassLoader</td>
<td>JAVA_HOME/jre/lib</td>
<td>无法直接访问</td>
</tr>
<tr>
<td>Extension ClassLoader</td>
<td>JAVA_HOME/jre/lib/ext</td>
<td>上级为 Bootstrap，显示为 null</td>
</tr>
<tr>
<td>Application ClassLoader</td>
<td>classpath</td>
<td>上级为 Extension</td>
</tr>
<tr>
<td>自定义类加载器自</td>
<td>自定义</td>
<td>上级为 Application</td>
</tr>
</tbody></table>
<h4 id="1-双亲委派"><a href="#1-双亲委派" class="headerlink" title="1.双亲委派"></a>1.双亲委派</h4><p>​    所谓的双亲委派，就是指调用类加载器的 loadClass 方法时，查找类的规则</p>
<blockquote>
<p>这里的双亲，翻译为上级似乎更为合适，因为它们并没有继承关系</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">        <span class="comment">// 1. 检查该类是否已经加载</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 2. 有上级的话，委派上级 loadClass</span></span><br><span class="line">                    c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 3. 如果没有上级了（ExtClassLoader），则委派</span></span><br><span class="line">                    BootstrapClassLoader</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t1 = System.nanoTime();</span><br><span class="line">                <span class="comment">// 4. 每一层找不到，调用 findClass 方法（每个类加载器自己扩展）来加载</span></span><br><span class="line">                c = findClass(name);</span><br><span class="line">                <span class="comment">// 5. 记录耗时</span></span><br><span class="line">                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">            resolveClass(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-线程上下文类加载器"><a href="#2-线程上下文类加载器" class="headerlink" title="2.线程上下文类加载器"></a>2.线程上下文类加载器</h4><p>我们在使用 JDBC 时，都需要加载 Driver 驱动，</p>
<p><code>Class.forName(&quot;com.mysql.jdbc.Driver&quot;)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 注册驱动的集合</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers</span><br><span class="line">        = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 初始化驱动</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loadInitialDrivers();</span><br><span class="line">        println(<span class="string">&quot;JDBC DriverManager initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>先不看别的，看看 DriverManager 的类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(DriverManager.class.getClassLoader());</span><br></pre></td></tr></table></figure>

<p>打印 null，表示它的类加载器是 Bootstrap ClassLoader，会到 JAVA_HOME/jre/lib 下搜索类，但JAVA_HOME/jre/lib 下显然没有 mysql-connector-java-5.1.47.jar 包，这样问题来了，在DriverManager 的静态代码块中，怎么能正确加载 com.mysql.jdbc.Driver 呢？</p>
<p>继续看 loadInitialDrivers() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadInitialDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String drivers;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        drivers = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;String&gt;</span><br><span class="line">                                                () &#123;</span><br><span class="line">                                                    <span class="function"><span class="keyword">public</span> String <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                                        <span class="keyword">return</span> System.getProperty(<span class="string">&quot;jdbc.drivers&quot;</span>);</span><br><span class="line">                                                    &#125;</span><br><span class="line">                                                &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        drivers = <span class="keyword">null</span>;</span><br><span class="line">    &#125;<span class="comment">// 1）使用 ServiceLoader 机制加载驱动，即 SPI</span></span><br><span class="line">    AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ServiceLoader&lt;Driver&gt; loadedDrivers =</span><br><span class="line">                ServiceLoader.load(Driver.class);</span><br><span class="line">            Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">while</span>(driversIterator.hasNext()) &#123;</span><br><span class="line">                    driversIterator.next();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">                <span class="comment">// Do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    println(<span class="string">&quot;DriverManager.initialize: jdbc.drivers = &quot;</span> + drivers);</span><br><span class="line">    <span class="comment">// 2）使用 jdbc.drivers 定义的驱动名加载驱动</span></span><br><span class="line">    <span class="keyword">if</span> (drivers == <span class="keyword">null</span> || drivers.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] driversList = drivers.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">    println(<span class="string">&quot;number of Drivers:&quot;</span> + driversList.length);</span><br><span class="line">    <span class="keyword">for</span> (String aDriver : driversList) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;DriverManager.Initialize: loading &quot;</span> + aDriver);</span><br><span class="line">            <span class="comment">// 这里的 ClassLoader.getSystemClassLoader() 就是应用程序类加载器</span></span><br><span class="line">            Class.forName(aDriver, <span class="keyword">true</span>,</span><br><span class="line">                          ClassLoader.getSystemClassLoader());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            println(<span class="string">&quot;DriverManager.Initialize: load failed: &quot;</span> + ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看 2）发现它最后是使用 Class.forName 完成类的加载和初始化，关联的是应用程序类加载器，因此<br>可以顺利完成类加载<br>再看 1）它就是大名鼎鼎的 Service Provider Interface （SPI）<br>约定如下，在 jar 包的 META-INF/services 包下，以接口全限定名名为文件，文件内容是实现类名称</p>
<img src="https://raw.githubusercontent.com/swz1216470093/blogComments/master/img/image-20210720000140849.png" alt="image-20210720000140849" style="zoom:80%;" />

<p>这样就可以使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ServiceLoader&lt;接口类型&gt; allImpls = ServiceLoader.load(接口类型.class);</span><br><span class="line">Iterator&lt;接口类型&gt; iter = allImpls.iterator();</span><br><span class="line"><span class="keyword">while</span>(iter.hasNext()) &#123;</span><br><span class="line">    iter.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来得到实现类，体现的是【面向接口编程+解耦】的思想</p>
<p>接着看 ServiceLoader.load 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取线程上下文类加载器</span></span><br><span class="line">    ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>线程在启动时jvm默认将应用程序类加载器赋值给当前线程。</p>
<p>线程上下文类加载器是当前线程使用的类加载器，默认就是应用程序类加载器，它内部又是由Class.forName 调用了线程上下文类加载器完成类加载，具体代码在 ServiceLoader 的内部类LazyIterator 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> S <span class="title">nextService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hasNextService())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</span><br><span class="line">    String cn = nextName;</span><br><span class="line">    nextName = <span class="keyword">null</span>;</span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//这里的loader其实就是应用程序类加载器</span></span><br><span class="line">        c = Class.forName(cn, <span class="keyword">false</span>, loader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException x) &#123;</span><br><span class="line">        fail(service,<span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!service.isAssignableFrom(c)) &#123;</span><br><span class="line">        fail(service,</span><br><span class="line">             <span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; not a subtype&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        S p = service.cast(c.newInstance());</span><br><span class="line">        providers.put(cn, p);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">        fail(service,</span><br><span class="line">             <span class="string">&quot;Provider &quot;</span> + cn + <span class="string">&quot; could not be instantiated&quot;</span>,</span><br><span class="line">             x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Error(); <span class="comment">// This cannot happen</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-自定义类加载器"><a href="#3-自定义类加载器" class="headerlink" title="3.自定义类加载器"></a>3.自定义类加载器</h4><p>自定义类加载器使用场景</p>
<p>1）想加载非 classpath 随意路径中的类文件<br>2）都是通过接口来使用实现，希望解耦时，常用在框架设计<br>3）这些类希望予以隔离，不同应用的同名类都可以加载，不冲突，常见于 tomcat 容器</p>
<p>步骤：</p>
<ol>
<li>继承ClassLoader父类</li>
<li>要遵从双亲委派机制，重写findclass方法<ul>
<li>注意不是loadclass方法， 否则会破坏双亲委派机制</li>
</ul>
</li>
<li>读取类文件的字节码</li>
<li>调用父类的defineClass方法来加载类</li>
<li>使用者调用该类加载器的loadClass方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderTest</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="comment">//name 就是类名称</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        String path = <span class="string">&quot;D:\\&quot;</span> + name + <span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Files.copy(Paths.get(path),bos);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = bos.toByteArray();</span><br><span class="line">            <span class="keyword">return</span> defineClass(name,bytes,<span class="number">0</span>,bytes.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&quot;类文件未找到&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ClassLoaderTest classLoaderTest = <span class="keyword">new</span> ClassLoaderTest();</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; mapImpl1 = classLoaderTest.loadClass(<span class="string">&quot;MyMapImpl1&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; mapImpl2 = classLoaderTest.loadClass(<span class="string">&quot;MyMapImpl2&quot;</span>);</span><br><span class="line">        System.out.println(mapImpl2 == mapImpl1);</span><br><span class="line">        System.out.println(mapImpl2.newInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>参考：黑马视频《解密JVM》</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/" rel="tag"># 类加载器</a>
              <a href="/blog/tags/%E5%AD%97%E8%8A%82%E7%A0%81/" rel="tag"># 字节码</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/blog/2021/07/28/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" rel="prev" title="垃圾回收">
      <i class="fa fa-chevron-left"></i> 垃圾回收
    </a></div>
      <div class="post-nav-item">
    <a href="/blog/2021/08/01/IO%E6%A8%A1%E5%9E%8B/" rel="next" title="IO模型">
      IO模型 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">1.</span> <span class="nav-text">类加载与字节码</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">1.类文件结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1%E9%AD%94%E6%95%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1魔数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E7%89%88%E6%9C%AC"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E5%B8%B8%E9%87%8F%E6%B1%A0"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 常量池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-%E7%BB%A7%E6%89%BF%E5%92%8C%E8%AE%BF%E9%97%AE%E6%A0%87%E8%AF%86%E4%BF%A1%E6%81%AF"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4 继承和访问标识信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-Field-%E4%BF%A1%E6%81%AF"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5 Field 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-Method-%E4%BF%A1%E6%81%AF"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.6 Method 信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7%E9%99%84%E5%8A%A0%E5%B1%9E%E6%80%A7"><span class="nav-number">1.1.7.</span> <span class="nav-text">1.7附加属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AD%97%E8%8A%82%E7%A0%81%E6%8C%87%E4%BB%A4"><span class="nav-number">1.2.</span> <span class="nav-text">2.字节码指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E5%8E%9F%E5%A7%8Bjava%E4%BB%A3%E7%A0%81"><span class="nav-number">1.2.1.</span> <span class="nav-text">1原始java代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91%E5%90%8E%E7%9A%84%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.编译后的字节码文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%B8%B8%E9%87%8F%E6%B1%A0%E8%BD%BD%E5%85%A5%E8%BF%90%E8%A1%8C%E6%97%B6"><span class="nav-number">1.2.3.</span> <span class="nav-text">3.常量池载入运行时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E6%96%B9%E6%B3%95%E5%AD%97%E8%8A%82%E7%A0%81%E8%BD%BD%E5%85%A5%E6%96%B9%E6%B3%95%E5%8C%BA"><span class="nav-number">1.2.4.</span> <span class="nav-text">4.方法字节码载入方法区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-main-%E7%BA%BF%E7%A8%8B%E5%BC%80%E5%A7%8B%E8%BF%90%E8%A1%8C%EF%BC%8C%E5%88%86%E9%85%8D%E6%A0%88%E5%B8%A7%E5%86%85%E5%AD%98"><span class="nav-number">1.2.5.</span> <span class="nav-text">5.main 线程开始运行，分配栈帧内存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E%E5%BC%80%E5%A7%8B%E6%89%A7%E8%A1%8C%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-number">1.2.6.</span> <span class="nav-text">6.执行引擎开始执行字节码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="nav-number">1.2.7.</span> <span class="nav-text">7构造方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-lt-cinit-gt-V"><span class="nav-number">1.2.7.1.</span> <span class="nav-text">1. &lt;cinit&gt;()V</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-lt-init-gt-V"><span class="nav-number">1.2.7.2.</span> <span class="nav-text">2. &lt;init&gt;()V</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8"><span class="nav-number">1.2.8.</span> <span class="nav-text">8. 方法调用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E7%BB%91%E5%AE%9A%E5%92%8C%E5%8A%A8%E6%80%81%E7%BB%91%E5%AE%9A"><span class="nav-number">1.2.8.1.</span> <span class="nav-text">静态绑定和动态绑定</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-%E5%A4%9A%E6%80%81%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-number">1.2.9.</span> <span class="nav-text">9.多态的原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BD%BF%E7%94%A8HSDB%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1%E5%9C%B0%E5%9D%80"><span class="nav-number">1.2.9.1.</span> <span class="nav-text">1. 使用HSDB查看对象地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.9.2.</span> <span class="nav-text">2.查看对象内存结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1-Class-%E7%9A%84%E5%86%85%E5%AD%98%E5%9C%B0%E5%9D%80"><span class="nav-number">1.2.9.3.</span> <span class="nav-text">3.查看对象 Class 的内存地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%9F%A5%E7%9C%8B%E7%B1%BB%E7%9A%84-vtable"><span class="nav-number">1.2.9.4.</span> <span class="nav-text">4.查看类的 vtable</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E9%AA%8C%E8%AF%81%E6%96%B9%E6%B3%95%E5%9C%B0%E5%9D%80"><span class="nav-number">1.2.9.5.</span> <span class="nav-text">5.验证方法地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E5%B0%8F%E7%BB%93"><span class="nav-number">1.2.9.6.</span> <span class="nav-text">6.小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">1.2.10.</span> <span class="nav-text">10.异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-try-catch"><span class="nav-number">1.2.10.1.</span> <span class="nav-text">1.try-catch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%A4%9A%E4%B8%AA-single-catch-%E5%9D%97%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.2.10.2.</span> <span class="nav-text">2.多个 single-catch 块的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-multi-catch-%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">1.2.10.3.</span> <span class="nav-text">3.multi-catch 的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-finally"><span class="nav-number">1.2.10.4.</span> <span class="nav-text">4.finally</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E7%BB%83%E4%B9%A0-finally-%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-number">1.2.10.5.</span> <span class="nav-text">5 练习 - finally 面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-finally-%E5%87%BA%E7%8E%B0%E4%BA%86-return"><span class="nav-number">1.2.10.5.1.</span> <span class="nav-text">1. finally 出现了 return</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-finally-%E5%AF%B9%E8%BF%94%E5%9B%9E%E5%80%BC%E5%BD%B1%E5%93%8D"><span class="nav-number">1.2.10.5.2.</span> <span class="nav-text">2.finally 对返回值影响</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%BC%96%E8%AF%91%E6%9C%9F%E5%A4%84%E7%90%86"><span class="nav-number">1.3.</span> <span class="nav-text">3.编译期处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E6%9E%9A%E4%B8%BE%E7%B1%BB"><span class="nav-number">1.3.0.1.</span> <span class="nav-text">1.枚举类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB"><span class="nav-number">1.3.0.2.</span> <span class="nav-text">2. 匿名内部类</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E9%98%B6%E6%AE%B5"><span class="nav-number">1.4.</span> <span class="nav-text">4.类加载阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.4.1.</span> <span class="nav-text">4.1 加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2%E9%93%BE%E6%8E%A5"><span class="nav-number">1.4.2.</span> <span class="nav-text">4.2链接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.4.2.4.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#lt-cinit-gt-V-%E6%96%B9%E6%B3%95"><span class="nav-number">1.4.2.4.1.</span> <span class="nav-text">&lt;cinit&gt;()V 方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%91%E7%94%9F%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-number">1.4.2.4.2.</span> <span class="nav-text">发生的时机</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.4.3.</span> <span class="nav-text">5.类加载器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">1.双亲委派</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">2.线程上下文类加载器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">3.自定义类加载器</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">swz</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">swz</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blog/lib/anime.min.js"></script>
  <script src="/blog/lib/velocity/velocity.min.js"></script>
  <script src="/blog/lib/velocity/velocity.ui.min.js"></script>

<script src="/blog/js/utils.js"></script>

<script src="/blog/js/motion.js"></script>


<script src="/blog/js/schemes/muse.js"></script>


<script src="/blog/js/next-boot.js"></script>




  













<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://swz1216470093.github.io/blog/2021/07/29/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81/',]
      });
      });
  </script>

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'cefa39253970229f8e5d',
      clientSecret: '81e0d672d6a3abf97548e8614c36a567dc55237a',
      repo        : 'blogComments',
      owner       : 'swz1216470093',
      admin       : ['swz1216470093'],
      id          : '2f4cc468af7f8978e795ef0f19364265',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
